@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer localizer;

@{
    ViewData["Title"] = "Listado de tareas";
}

<div class="text-center mb-4">
    <h1 class="h2 text-primary">@localizer["Mis tareas"]</h1>

    <button type="button" class="btn btn-primary mt-3 btn-lg" onclick="agregarNuevaTareaListado()">
        <i class="bi bi-plus-circle me-2"></i> 
        @localizer["AgregarNuevaTarea"]
    </button>
</div>

<div id="contenedor-listado-tareas" class="container-md mx-auto">

    <div id="reordenable" class="text-start" data-bind="foreach: tareas">

        <div name="tarea"
             class="card mb-3 shadow-sm task-card-hover"
             style="cursor: pointer"
             data-bind="click: manejarClickTarea, css: {'border-success border-2': pasosTotal() > 0 && pasosRealizados() === pasosTotal() }">

            <div class="card-body p-3 d-flex justify-content-between align-items-center">

                <div class="flex-grow-1 me-3">

                    <div data-bind="text: titulo, hidden: esNuevo"
                         class="fw-bold fs-5 text-truncate">
                    </div>

                    <input type="text" name="titulo-tarea" autocomplete="off"
                           class="form-control"
                           data-bind="value: titulo, visible: esNuevo,
                                      attr:{'data-id': id},
                                      event: {focusout: manejarFocusOutTituloTarea}" />
                </div>

                <div name="pasos-resumen" class="text-end flex-shrink-0"
                     data-bind="visible: pasosTotal() > 0">

                    <div class="progress mb-1" style="width: 100px; height: 8px;">
                        <div class="progress-bar progress-bar-striped" role="progressbar"
                             data-bind="style: { width: porcentajeCompletadoSinParentesis, backgroundColor: pasosRealizados() === pasosTotal() ? '#28a745' : '' }"
                             aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>

                    <small class="text-muted fw-semibold">
                        <span data-bind="text: pasosRealizados"></span>
                        /
                        <span data-bind="text: pasosTotal"></span>
                        <span data-bind="text: porcentajeCompletado"></span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div data-bind="visible: cargando" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">@localizer["Cargando..."]</span>
        </div>
    </div>

    <div data-bind="visible: noHayTareas" class="alert alert-info mt-4 text-center">
        <i class="bi bi-info-circle-fill me-2"></i> @localizer["No existen tareas para mostrar"]
    </div>
</div>

<partial name="_ModalEditarTarea" />

@section Scripts {

    <script src="~/js/tareas.js" asp-append-version="true"></script>
    <script src="~/js/utilidades.js" asp-append-version="true"></script>
    <script src="~/js/pasos.js" asp-append-version="true"></script>
    <script src="~/js/archivos-adjuntos.js" asp-append-version="true"></script>


    <script>

        const urlTareas ="/api/tareas";
        const urlPasos = "/api/pasos";
        const urlArchivos = "/api/archivos";

        const modalEditarTarea = document.getElementById('modal-editar-tarea');
        const modalEditarTareaBootstrap = new bootstrap.Modal(modalEditarTarea);

        function tareaListadoViewModelFn() {
            var self = this;
            self.tareas = ko.observableArray([]);
            self.cargando = ko.observable(true);

            self.noHayTareas = ko.pureComputed(function(){
                if(self.cargando()){
                    return false;
                }
                return self.tareas().length === 0;
            })
        }

        function tareaElementoListadoViewModel({id, titulo, pasosTotal, pasosRealizados}){
            var self = this;
            self.id = ko.observable(id);
            self.titulo = ko.observable(titulo);

            self.pasosTotal = ko.observable(pasosTotal);
            self.pasosRealizados = ko.observable(pasosRealizados);

            self.esNuevo = ko.pureComputed(function(){
                return self.id() == 0;
            })

            // Computed original (para texto: (X%))
            self.porcentajeCompletado = ko.pureComputed(function(){
                // Asegura que no divida por cero
                const calculo = self.pasosTotal() === 0 ? 0 : Math.round(self.pasosRealizados() * 1.0 / self.pasosTotal() * 100);
                return `(${calculo}%)`;
            });

            // **CORRECCIÓN VISUAL:** Necesario para el atributo 'width' de la barra de progreso de Bootstrap
            self.porcentajeCompletadoSinParentesis = ko.pureComputed(function(){
                // Asegura que no divida por cero
                const calculo = self.pasosTotal() === 0 ? 0 : Math.round(self.pasosRealizados() * 1.0 / self.pasosTotal() * 100);
                return `${calculo}%`;
            });
        }

        const tareaEditarVM ={
            id: 0,
            titulo: ko.observable(''),
            descripcion: ko.observable(''),
            pasos: ko.observableArray([]),
            archivosAdjuntos: ko.observableArray([])
        }

        const tareaListadoViewModel = new tareaListadoViewModelFn();

        function pasoViewModel({id,descripcion,realizado,modoEdicion}){
            var self = this;
            self.id = ko.observable(id || 0);
            self.descripcion = ko.observable(descripcion || '');
            self.descripcionAnterior = '';
            self.realizado = ko.observable(realizado);
            self.modoEdicion = ko.observable(modoEdicion);

            self.esNuevo = ko.pureComputed(function (){
                return self.id() == 0;
            })
        }

        function archivoAdjuntoViewModel({id, titulo, publicado, modoEdicion,orden, url}){
            var self = this;
            self.id = id;
            self.titulo = ko.observable(titulo || '');
            self.publicado = publicado;
            self.modoEdicion = ko.observable(modoEdicion);
            self.orden = orden;
            self.ur = url;
        }

        obtenerTareas();

        ko.applyBindings(tareaListadoViewModel, document.getElementById('contenedor-listado-tareas'));
        ko.applyBindings(tareaEditarVM,document.getElementById('modal-editar-tarea'));
    </script>
}